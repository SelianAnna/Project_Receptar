{% extends "base.html" %}
{% block title %}{% if object %}Upraviť recept{% else %}Pridať recept{% endif %} — Receptár{% endblock %}
{% block content %}
<h1>{% if object %}Upraviť recept{% else %}Pridať recept{% endif %}</h1>

<form method="post" enctype="multipart/form-data" class="mt-3" id="recipe-form">
  {% csrf_token %}

  <div class="mb-3">{{ form.title.label_tag }} {{ form.title }}</div>
  <div class="mb-3">{{ form.description.label_tag }} {{ form.description }}</div>
  <div class="mb-3">{{ form.instructions.label_tag }} {{ form.instructions }}</div>
  <div class="mb-3">{{ form.image.label_tag }} {{ form.image }}</div>

  <h5>Ingrediencie</h5>
  <div id="ingredient-rows">
    {# Ak upravujeme a recept má ingrediencie, predvyplň ich #}
    {% if object %}
      {% with items=object.recipeingredient_set.all %}
        {% if items %}
          {% for ri in items %}
            <div class="row g-2 mb-2 ingredient-row">
              <div class="col-md-6">
                <input type="text" name="ingredient_name" class="form-control" placeholder="Názov ingrediencie" value="{{ ri.ingredient.name }}">
              </div>
              <div class="col-md-4">
                <input type="text" name="ingredient_amount" class="form-control" placeholder="Množstvo (napr. 200 g)" value="{{ ri.amount }}">
              </div>
              <div class="col-md-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger remove-row{% if forloop.first and items|length == 1 %} d-none{% endif %}">&minus;</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          {# nemá žiadne ingrediencie -> zobraz prázdny riadok #}
          <div class="row g-2 mb-2 ingredient-row">
            <div class="col-md-6">
              <input type="text" name="ingredient_name" class="form-control" placeholder="Názov ingrediencie">
            </div>
            <div class="col-md-4">
              <input type="text" name="ingredient_amount" class="form-control" placeholder="Množstvo (napr. 200 g)">
            </div>
            <div class="col-md-2 d-flex align-items-center">
              <button type="button" class="btn btn-danger remove-row d-none">&minus;</button>
            </div>
          </div>
        {% endif %}
      {% endwith %}
    {% else %}
      {# vytváranie -> jeden prázdny riadok #}
      <div class="row g-2 mb-2 ingredient-row">
        <div class="col-md-6">
          <input type="text" name="ingredient_name" class="form-control" placeholder="Názov ingrediencie">
        </div>
        <div class="col-md-4">
          <input type="text" name="ingredient_amount" class="form-control" placeholder="Množstvo (napr. 200 g)">
        </div>
        <div class="col-md-2 d-flex align-items-center">
          <button type="button" class="btn btn-danger remove-row d-none">&minus;</button>
        </div>
      </div>
    {% endif %}
  </div>

  <button type="button" id="add-ingredient-row" class="btn btn-secondary mb-3">+ Pridať ingredienciu</button>

  <button class="btn btn-primary">Uložiť</button>
</form>

{# Šablóna nového riadka na klonovanie #}
<template id="ingredient-row-template">
  <div class="row g-2 mb-2 ingredient-row">
    <div class="col-md-6">
      <input type="text" name="ingredient_name" class="form-control" placeholder="Názov ingrediencie">
    </div>
    <div class="col-md-4">
      <input type="text" name="ingredient_amount" class="form-control" placeholder="Množstvo (napr. 200 g)">
    </div>
    <div class="col-md-2 d-flex align-items-center">
      <button type="button" class="btn btn-danger remove-row">&minus;</button>
    </div>
  </div>
</template>

<script>
  (function() {
    const container = document.getElementById('ingredient-rows');
    const addBtn = document.getElementById('add-ingredient-row');
    const tpl = document.getElementById('ingredient-row-template');

    function updateRemoveButtons() {
      const rows = container.querySelectorAll('.ingredient-row');
      rows.forEach((row, idx) => {
        const btn = row.querySelector('.remove-row');
        if (rows.length === 1 && idx === 0) {
          btn.classList.add('d-none');
        } else {
          btn.classList.remove('d-none');
        }
      });
    }

    addBtn.addEventListener('click', () => {
      const node = tpl.content.firstElementChild.cloneNode(true);
      container.appendChild(node);
      updateRemoveButtons();
    });

    container.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-row')) {
        const row = e.target.closest('.ingredient-row');
        row.remove();
        updateRemoveButtons();
      }
    });

    // inicializácia
    updateRemoveButtons();
  })();
</script>
{% endblock %}